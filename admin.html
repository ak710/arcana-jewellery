<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Arcana Admin â€” Add Item</title>
  <link rel="icon" type="image/png" href="Favicon.png">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;600;700&family=Outfit:wght@300;400;600&display=swap" rel="stylesheet">
  <style>
    @font-face {
      font-family: 'KudryashevDisplay';
      src: url('https://db.onlinewebfonts.com/t/157c6cc36dd65b1b2adc9e7f3329c761.eot');
      src: url('https://db.onlinewebfonts.com/t/157c6cc36dd65b1b2adc9e7f3329c761.eot?#iefix') format('embedded-opentype'),
           url('https://db.onlinewebfonts.com/t/157c6cc36dd65b1b2adc9e7f3329c761.woff2') format('woff2'),
           url('https://db.onlinewebfonts.com/t/157c6cc36dd65b1b2adc9e7f3329c761.woff') format('woff'),
           url('https://db.onlinewebfonts.com/t/157c6cc36dd65b1b2adc9e7f3329c761.ttf') format('truetype'),
           url('https://db.onlinewebfonts.com/t/157c6cc36dd65b1b2adc9e7f3329c761.svg#KudryashevDisplay') format('svg');
    }
    .logo { font-family: 'KudryashevDisplay', serif; }
  </style>
  <script>
    window.tailwind = window.tailwind || {};
    window.tailwind.config = {
      darkMode: 'class',
      theme: {
        extend: {
          colors: {
            cream: '#FAF9F6',
            gold: '#C9A961',
            'gold-dim': '#A68B4F',
            'gold-light': '#E8D9B0',
            'arcana-charcoal': '#0F0F0F',
            'arcana-ebony': '#1A1A1A'
          }
        }
      }
    };
  </script>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="theme.js"></script>
  <!-- Fill these meta tags with your Supabase project values -->
  <meta name="supabase-url" content="https://gktehkfaiqutjrunfyah.supabase.co">
  <meta name="supabase-anon-key" content="sb_publishable_vDVciGc-1-vg0HXe3MmHAg_V6Ea90hQ">
    <!-- The URL the magic-link will redirect to after verification. 
      Set to your Netlify site to avoid localhost redirects. -->
    <meta name="supabase-redirect" content="https://arcana-jewellery.netlify.app/admin.html">
  <style>
    body { font-family: Inter, ui-sans-serif, system-ui, -apple-system, 'Segoe UI', Roboto, 'Helvetica Neue', Arial; }
  </style>
</head>
<body class="min-h-screen bg-gradient-to-b from-white to-cream dark:bg-gradient-to-b dark:from-[#0F0F0F] dark:to-[#1A1A1A] flex items-start justify-center p-8 text-slate-900 dark:text-slate-100">
    <!-- Theme Toggle Button -->
  <button class="theme-toggle" id="theme-toggle" aria-label="Toggle dark mode">
    <span id="theme-icon">ðŸŒ™</span>
  </button>

<div class="w-full max-w-2xl">
    <div class="logo text-5xl text-gold mb-4 text-center">Arcana</div>
    <h1 class="text-2xl font-semibold mb-4">Arcana Admin â€” Add Item</h1>

    <div id="auth-area" class="mb-6 p-4 bg-white rounded shadow">
      <h2 class="font-medium mb-2">Sign in (admin)</h2>
      <p class="text-sm text-gray-600 mb-3">Enter your admin email to receive a magic link for sign-in.</p>
      <div class="flex gap-2">
        <input id="admin-email" type="email" placeholder="admin@example.com" class="flex-1 p-2 border rounded" />
        <button id="btn-send-link" class="px-4 py-2 bg-blue-600 text-white rounded">Send Link</button>
      </div>
      <p id="auth-msg" class="text-sm mt-2 text-gray-500"></p>
    </div>

    <div id="form-area" class="hidden p-6 bg-white rounded shadow">
      <h2 class="font-medium mb-4">Add / Update Item</h2>
      <div class="mb-4 text-sm text-gray-600">
        Signed in as: <span id="session-user-id" class="font-mono text-xs"></span>
      </div>
      <form id="item-form" class="space-y-4">
        <div>
          <label class="block text-sm font-medium">Item ID</label>
          <input id="item-id" class="w-full p-2 border rounded" required />
        </div>

        <div>
          <label class="block text-sm font-medium">Sender</label>
          <input id="sender" class="w-full p-2 border rounded" />
        </div>

        <div>
          <label class="block text-sm font-medium">Video embed URL</label>
          <input id="video-url" class="w-full p-2 border rounded" placeholder="https://www.youtube.com/embed/..." />
        </div>

        <div>
          <label class="block text-sm font-medium">Message Title</label>
          <input id="message-title" class="w-full p-2 border rounded" placeholder="e.g. Happy Anniversary" />
        </div>


        <div>
          <label class="block text-sm font-medium">Message text</label>
          <textarea id="message-text" rows="4" class="w-full p-2 border rounded"></textarea>
        </div>

        <div>
          <label class="block text-sm font-medium">Signature (optional)</label>
          <input id="message-signature" class="w-full p-2 border rounded" placeholder="e.g. - Alex" />
        </div>

        <hr class="my-4 border-gray-300" />
        <h3 class="text-lg font-semibold mb-3">Vault Extras</h3>

        <div class="grid grid-cols-2 gap-4">
          <div>
            <label class="block text-sm font-medium">Voice note URL</label>
            <input id="voice-url" class="w-full p-2 border rounded" placeholder="https://.../voice.mp3" />
          </div>
          <div>
            <label class="block text-sm font-medium">Song embed / link</label>
            <input id="song-embed" class="w-full p-2 border rounded" placeholder="Spotify or YouTube embed/link" />
          </div>
        </div>

        <div class="grid grid-cols-2 gap-4">
          <div>
            <label class="block text-sm font-medium">Location label</label>
            <input id="location-label" class="w-full p-2 border rounded" placeholder="e.g. Paris Proposal" />
          </div>
          <div>
            <label class="block text-sm font-medium">Location URL (optional)</label>
            <input id="location-url" class="w-full p-2 border rounded" placeholder="https://maps.google.com/?q=..." />
          </div>
        </div>

        <div class="grid grid-cols-2 gap-4">
          <div>
            <label class="block text-sm font-medium">Location latitude (optional)</label>
            <input id="location-lat" class="w-full p-2 border rounded" placeholder="48.8584" />
          </div>
          <div>
            <label class="block text-sm font-medium">Location longitude (optional)</label>
            <input id="location-lng" class="w-full p-2 border rounded" placeholder="2.2945" />
          </div>
        </div>

        <div>
          <label class="block text-sm font-medium">Created at (optional)</label>
          <input id="created-at" type="datetime-local" class="w-full p-2 border rounded" />
          <p class="text-xs text-gray-500 mt-1">Leave blank to let the database default apply.</p>
        </div>

        <hr class="my-4 border-gray-300" />
        <h3 class="text-lg font-semibold mb-3">Piece Details</h3>

        <div class="grid grid-cols-2 gap-4">
          <div>
            <label class="block text-sm font-medium">Stone Size (optional)</label>
            <input id="stone-size" class="w-full p-2 border rounded" placeholder="e.g. 1.5ct, 6mm" />
          </div>

          <div>
            <label class="block text-sm font-medium">Stone Quality (optional)</label>
            <input id="stone-quality" class="w-full p-2 border rounded" placeholder="e.g. VS1, F color" />
          </div>

          <div>
            <label class="block text-sm font-medium">Metal Type (optional)</label>
            <input id="metal-type" class="w-full p-2 border rounded" placeholder="e.g. Gold, Silver, Platinum" />
          </div>

          <div>
            <label class="block text-sm font-medium">Metal Purity (optional)</label>
            <input id="metal-purity" class="w-full p-2 border rounded" placeholder="e.g. 18K, 14K, 925" />
          </div>
        </div>

        <div>
          <label class="block text-sm font-medium">Certification URL (optional)</label>
          <input id="certification-url" class="w-full p-2 border rounded" placeholder="https://igi.org/reports/..." />
        </div>

        <hr class="my-4 border-gray-300" />

        <div>
          <label class="block text-sm font-medium">Model (choose existing)</label>
          <div class="flex gap-2 items-center">
            <div class="flex-1 text-sm text-gray-600">Select one of the existing models below</div>
            <button id="btn-refresh-models" type="button" class="px-3 py-2 bg-gray-100 rounded">Refresh</button>
          </div>
          <div id="model-list" class="w-full mt-2 p-2 border rounded text-sm max-h-40 overflow-auto"></div>
        </div>

        <div>
          <label class="block text-sm font-medium">Manual model URL (optional)</label>
          <input id="model-url-manual" class="w-full p-2 border rounded" placeholder="https://storage.../my-model.glb" />
        </div>

        <div>
          <label class="block text-sm font-medium">3D iframe URL (optional)</label>
          <input id="iframe-url" class="w-full p-2 border rounded" placeholder="https://your-3d-provider/embed/..." />
        </div>

        <div class="flex gap-2">
          <button type="submit" class="px-4 py-2 bg-green-600 text-white rounded">Save Item</button>
          <button id="btn-logout" type="button" class="px-4 py-2 bg-gray-200 rounded">Sign out</button>
        </div>
      </form>

      <div class="mt-3">
        <div id="payload-preview" class="text-xs text-gray-500 break-words"></div>
        <p id="form-msg" class="text-sm mt-2 text-gray-600"></p>
      </div>
    </div>

    <div class="mt-6 text-xs text-gray-500">
      <p>Notes:</p>
      <ul class="list-disc pl-5">
        <li>You must set the Supabase project URL and anon key in the meta tags above.</li>
        <li>Uploads are stored in the `models` storage bucket. Ensure this bucket exists.</li>
        <li>Authenticated users can insert/upsert rows into the `items` table. Configure your RLS policies accordingly for admins.</li>
      </ul>
    </div>
  </div>

  <!-- Debug UI removed for production-readiness. Use browser console for logs. -->

  <script type="module">
    import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm'

    const SUPABASE_URL = document.querySelector('meta[name="supabase-url"]').content;
    const SUPABASE_ANON_KEY = document.querySelector('meta[name="supabase-anon-key"]').content;
    if (!SUPABASE_URL || SUPABASE_URL.includes('YOUR-PROJECT')) {
      document.getElementById('auth-msg').innerText = 'Please set your Supabase URL in the meta tag at the top of this page.';
    }

    const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    const authArea = document.getElementById('auth-area');
    const formArea = document.getElementById('form-area');
    const authMsg = document.getElementById('auth-msg');
    const formMsg = document.getElementById('form-msg');

    // Handle magic link sign-in
      document.getElementById('btn-send-link').addEventListener('click', async () => {
        const email = document.getElementById('admin-email').value.trim();
        if (!email) { authMsg.innerText = 'Enter a valid email.'; return; }
        authMsg.innerText = 'Sending magic linkâ€¦';
        // Read redirect target from meta tag so we don't redirect to localhost
        const redirectMeta = document.querySelector('meta[name="supabase-redirect"]');
        const redirectTo = (redirectMeta && redirectMeta.content) ? redirectMeta.content : (window.location.origin + '/admin.html');
        const { error } = await supabase.auth.signInWithOtp({ email, options: { emailRedirectTo: redirectTo } });
        if (error) authMsg.innerText = 'Error sending link: ' + error.message;
        else authMsg.innerText = 'Magic link sent â€” check your email.';
    });

    // Monitor auth state and populate the signed-in user display
    supabase.auth.onAuthStateChange(async (event, session) => {
      const userId = session && session.user ? session.user.id : '';
      const userEmail = session && session.user ? session.user.email : '';
      const sessionEl = document.getElementById('session-user-id');
      if (sessionEl) sessionEl.innerText = userId;
      
      if (session && session.user) {
        // Check if user is an admin
        try {
          const { data: adminCheck, error: adminErr } = await supabase
            .from('admins')
            .select('email')
            .eq('email', userEmail)
            .maybeSingle();
          
          if (adminErr) {
            console.warn('Admin check failed', adminErr);
            authMsg.innerText = 'Error verifying admin status.';
            await supabase.auth.signOut();
            return;
          }
          
          if (!adminCheck) {
            // User is not an admin
            authMsg.innerText = `Access denied. ${userEmail} is not authorized as an admin.`;
            await supabase.auth.signOut();
            return;
          }
          
          // User is authorized
          authArea.classList.add('hidden');
          formArea.classList.remove('hidden');
          authMsg.innerText = '';
          console.debug('Admin verified:', userEmail);
        } catch (e) {
          console.warn('Admin verification exception', e);
          authMsg.innerText = 'Error verifying admin status.';
          await supabase.auth.signOut();
        }
      } else {
        authArea.classList.remove('hidden');
        formArea.classList.add('hidden');
      }
    });

    // Also check admin status on initial load in case a session already exists
    (async () => {
      try {
        const { data: { session } } = await supabase.auth.getSession();
        const userId = session && session.user ? session.user.id : '';
        const userEmail = session && session.user ? session.user.email : '';
        const sessionEl = document.getElementById('session-user-id');
        if (sessionEl) sessionEl.innerText = userId;
        
        if (session && session.user) {
          // Check admin status
          const { data: adminCheck, error: adminErr } = await supabase
            .from('admins')
            .select('email')
            .eq('email', userEmail)
            .maybeSingle();
          
          if (adminCheck) {
            authArea.classList.add('hidden');
            formArea.classList.remove('hidden');
            authMsg.innerText = '';
          } else {
            authArea.classList.remove('hidden');
            formArea.classList.add('hidden');
            authMsg.innerText = `${userEmail} is not authorized as an admin.`;
            await supabase.auth.signOut();
          }
        }
      } catch (e) {
        console.warn('Initial session/admin check failed', e);
      }
    })();

    // NOTE: Inlined UI debug helper removed to keep admin UI lightweight.
    // Use `console.debug(...)` in the script instead where helpful.

    // Load list of models from the `models` storage bucket and populate the select.
    async function loadModels() {
      try {
        const listRes = await supabase.storage.from('models').list('', { limit: 1000 });
        console.debug('List models', listRes);
        const items = listRes.data || [];
        // keep a reference for quick manual inspection if needed
        window._modelsList = items;
        const listEl = document.getElementById('model-list');
        if (!listEl) return;
        listEl.innerHTML = '';

        // If there are no items, show a helpful message
        if (!items.length) {
          const p = document.createElement('div');
          p.className = 'text-xs text-gray-500 p-2';
          p.innerText = 'No models found in the storage bucket.';
          listEl.appendChild(p);
          return;
        }

        for (const it of items) {
          // get public url (fallback to constructed public path if missing)
          const urlRes = await supabase.storage.from('models').getPublicUrl(it.name);
          let publicUrl = (urlRes && urlRes.data && (urlRes.data.publicUrl || urlRes.data.public_url)) || urlRes.publicUrl || null;
          if (!publicUrl) {
            const SUPABASE_URL_META = document.querySelector('meta[name="supabase-url"]')?.content || '';
            publicUrl = `${SUPABASE_URL_META}/storage/v1/object/public/models/${encodeURIComponent(it.name)}`;
          }

          const idSafe = `model-${it.name.replace(/[^a-z0-9-_\.]/gi, '_')}`;
          const row = document.createElement('div');
          row.className = 'flex items-center gap-2 p-1';
          const radio = document.createElement('input');
          radio.type = 'radio';
          radio.name = 'model-radio';
          radio.id = idSafe;
          radio.value = publicUrl;
          radio.className = 'mr-2';
          const label = document.createElement('label');
          label.htmlFor = idSafe;
          label.className = 'text-sm';
          label.innerText = it.name;
          row.appendChild(radio);
          row.appendChild(label);
          listEl.appendChild(row);
        }
        } catch (e) {
        console.warn('loadModels failed', e);
        console.debug('loadModels exception', e);
      }
    }

    // Wire up refresh
    document.addEventListener('click', (ev) => {
      if (ev.target && ev.target.id === 'btn-refresh-models') loadModels();
    });

    // Fetch piece details from model_iframes table and auto-fill form
    async function fetchAndPopulateModelDetails(modelUrl) {
      if (!modelUrl || !SUPABASE_URL || !SUPABASE_ANON_KEY) return;
      try {
        const url = `${SUPABASE_URL}/rest/v1/model_iframes?model_url=eq.${encodeURIComponent(modelUrl)}&select=*`;
        const resp = await fetch(url, {
          headers: {
            'apikey': SUPABASE_ANON_KEY,
            'Authorization': `Bearer ${SUPABASE_ANON_KEY}`,
            'Content-Type': 'application/json'
          }
        });
        if (resp && resp.ok) {
          const rows = await resp.json();
          if (Array.isArray(rows) && rows.length > 0) {
            const modelData = rows[0];
            // Auto-fill the form fields
            if (modelData.stone_size) document.getElementById('stone-size').value = modelData.stone_size;
            if (modelData.stone_quality) document.getElementById('stone-quality').value = modelData.stone_quality;
            if (modelData.metal_type) document.getElementById('metal-type').value = modelData.metal_type;
            if (modelData.metal_purity) document.getElementById('metal-purity').value = modelData.metal_purity;
            if (modelData.certification_url) document.getElementById('certification-url').value = modelData.certification_url;
            if (modelData.iframe_url) document.getElementById('iframe-url').value = modelData.iframe_url;
            console.debug('Populated model_iframes details', modelData);
          }
        }
      } catch (e) { console.warn('fetchAndPopulateModelDetails failed', e); }
    }

    // Listen for model selection and auto-populate details
    document.addEventListener('change', (ev) => {
      if (ev.target && ev.target.name === 'model-radio') {
        fetchAndPopulateModelDetails(ev.target.value);
      }
    });

    // Wire up refresh

    // Load models when auth state shows signed-in user
    supabase.auth.onAuthStateChange((event, session) => {
      if (session && session.user) {
        loadModels();
      }
    });

    // also call on initial load in case the session exists already
    (async () => {
      try {
        const { data: { session } } = await supabase.auth.getSession();
        if (session && session.user) await loadModels();
      } catch (e) { /* ignore */ }
    })();

    // logout
    document.getElementById('btn-logout').addEventListener('click', async () => {
      await supabase.auth.signOut();
      formMsg.innerText = 'Signed out.';
    });

    document.getElementById('item-form').addEventListener('submit', async (e) => {
      e.preventDefault();
      formMsg.innerText = '';
      const id = document.getElementById('item-id').value.trim();
      const sender = document.getElementById('sender').value.trim();
      const video = document.getElementById('video-url').value.trim();
      const title = document.getElementById('message-title').value.trim();
      const message = document.getElementById('message-text').value.trim();
      const signature = document.getElementById('message-signature').value.trim();
      const voice = document.getElementById('voice-url').value.trim();
      const song = document.getElementById('song-embed').value.trim();
      const locationLabel = document.getElementById('location-label').value.trim();
      const locationUrl = document.getElementById('location-url').value.trim();
      const locationLatRaw = document.getElementById('location-lat').value.trim();
      const locationLngRaw = document.getElementById('location-lng').value.trim();
      const createdAtRaw = document.getElementById('created-at').value.trim();
      const manualModel = document.getElementById('model-url-manual').value.trim();
      const iframeUrl = document.getElementById('iframe-url').value.trim();

      if (!id) { formMsg.innerText = 'Item ID is required.'; return; }

      // Ensure user is authenticated and fetch their id for created_by
      const { data: sessionData, error: sessionErr } = await supabase.auth.getSession();
      const session = sessionData && sessionData.session ? sessionData.session : null;
      // Fallback to getUser for older SDK behavior
      let user = null;
      if (session && session.user) user = session.user;
      else {
        const { data: userData, error: userErr } = await supabase.auth.getUser();
        if (userData && userData.user) user = userData.user;
      }
      if (sessionErr || !user) {
        formMsg.innerText = 'You must be signed in to save items. Please sign in with the magic link.';
        return;
      }
      const userId = user.id;
      // show logged-in user id in UI for debugging
      const sessionEl = document.getElementById('session-user-id');
      if (sessionEl) sessionEl.innerText = userId;

      // Use manual model URL if provided, otherwise use selected radio choice
      let modelUrl = null;
      const sel = document.querySelector('input[name="model-radio"]:checked');
      if (manualModel && manualModel.length) modelUrl = manualModel;
      else if (sel) modelUrl = sel.value;

      // Optional numeric/location/date parsing
      const locationLat = locationLatRaw ? parseFloat(locationLatRaw) : null;
      const locationLng = locationLngRaw ? parseFloat(locationLngRaw) : null;
      const createdAt = createdAtRaw ? new Date(createdAtRaw) : null;
      const createdAtIso = createdAt && !isNaN(createdAt.valueOf()) ? createdAt.toISOString() : null;

      // Prepare payload and show preview
      const payload = {
        id,
        sender: sender || null,
        title: title || null,
        message: message || null,
        signature: signature || null,
        voice_url: voice || null,
        song_embed: song || null,
        location_label: locationLabel || null,
        location_url: locationUrl || null,
        location_lat: Number.isFinite(locationLat) ? locationLat : null,
        location_lng: Number.isFinite(locationLng) ? locationLng : null,
        video_url: video || null,
        iframe_url: iframeUrl || null,
        created_by: userId
      };
      if (createdAtIso) payload.created_at = createdAtIso;
      if (modelUrl) {
        // store model URL only. Some schemas don't have a `model` column
        // and will error if we attempt to write it. Use `model_url` as
        // the canonical field name.
        payload.model_url = modelUrl;
        console.debug('Selected model value', modelUrl);
      }
      const previewEl = document.getElementById('payload-preview');
      if (previewEl) previewEl.innerText = 'Payload:\n' + JSON.stringify(payload, null, 2);
      // Helpful developer logs (view in browser console)
      console.debug('Session before save', session || { user });
      console.debug('Prepared payload', payload);

      formMsg.innerText = 'Checking existing itemâ€¦';
      // Check if item exists and who owns it
      const { data: existing, error: fetchErr } = await supabase.from('items').select('created_by').eq('id', id).maybeSingle();
      if (fetchErr) {
        // non-fatal: log and continue â€” sometimes maybeSingle returns errors for other reasons
        console.warn('fetch existing error', fetchErr);
        console.debug('Fetch existing error', fetchErr);
      }

      // If an existing row is present and owned by someone else, block the update
      if (existing && existing.created_by && existing.created_by !== userId) {
        formMsg.innerText = 'Save failed: this item already exists and is owned by another user (' + existing.created_by + ').';
        return;
      }

      formMsg.innerText = existing ? 'Updating existing itemâ€¦' : 'Creating new itemâ€¦';

      let result;
      if (existing) {
        // Owner matches or created_by is null â€” perform an update
        result = await supabase.from('items').update(payload).eq('id', id).select();
      } else {
        // Insert new row (preferred for first-time insert to satisfy WITH CHECK)
        result = await supabase.from('items').insert(payload).select();
      }

      const { data, error } = result || {};
      if (error) {
        console.error('save error', error);
        console.debug('Save error', error);
        // Helpful guidance for a common schema mismatch (missing 'model' column)
        if (error.message && error.message.includes("Could not find the 'model' column")) {
          formMsg.innerText = "Save failed: database schema missing 'model' column. " +
            "Either add a 'model' column to the 'items' table or modify the schema to include 'model_url' and migrate data accordingly.";
        } else {
          formMsg.innerText = 'Save failed: ' + (error.message || JSON.stringify(error));
        }
      } else {
        formMsg.innerText = 'Saved successfully!';
        // Reset model radio selection
        const checked = document.querySelector('input[name="model-radio"]:checked');
        if (checked) checked.checked = false;
        if (previewEl) previewEl.innerText = '';
      }
    });
  </script>
</body>
</html>
