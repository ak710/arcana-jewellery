<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Arcana â€” Scan Item</title>
    <link rel="icon" type="image/png" href="Favicon.png">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@600;700;800&family=Inter:wght@300;400;500;600&display=swap" rel="stylesheet">
    <style>
      @font-face {
        font-family: 'KudryashevDisplay';
        src: url('https://db.onlinewebfonts.com/t/157c6cc36dd65b1b2adc9e7f3329c761.eot');
        src: url('https://db.onlinewebfonts.com/t/157c6cc36dd65b1b2adc9e7f3329c761.eot?#iefix') format('embedded-opentype'),
             url('https://db.onlinewebfonts.com/t/157c6cc36dd65b1b2adc9e7f3329c761.woff2') format('woff2'),
             url('https://db.onlinewebfonts.com/t/157c6cc36dd65b1b2adc9e7f3329c761.woff') format('woff'),
             url('https://db.onlinewebfonts.com/t/157c6cc36dd65b1b2adc9e7f3329c761.ttf') format('truetype'),
             url('https://db.onlinewebfonts.com/t/157c6cc36dd65b1b2adc9e7f3329c761.svg#KudryashevDisplay') format('svg');
      }
      .logo { font-family: 'KudryashevDisplay', serif; }
      /* Design System: Serif font (Playfair Display) for emotional content & titles */
      .serif-title, h1, h2, h3, .serif { font-family: 'Playfair Display', serif; font-weight: 700; font-style: normal; }
      /* Design System: Sans-serif font (Inter) for UI & labels */
      body, .sans-serif { font-family: 'Inter', sans-serif; font-weight: 400; font-style: normal; }
    </style>
    <script>
      window.tailwind = window.tailwind || {};
      window.tailwind.config = {
        darkMode: 'class',
        theme: {
          extend: {
            colors: {
              cream: '#FAF9F6',
              gold: '#C9A961',
              'gold-dim': '#A68B4F',
              'gold-light': '#E8D9B0',
              'arcana-charcoal': '#0F0F0F',
              'arcana-ebony': '#1A1A1A'
            }
          }
        }
      };
    </script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <link rel="stylesheet" href="styles.css">
    <script src="theme.js"></script>
  </head>
  <body class="min-h-screen bg-gradient-to-b from-white to-cream dark:bg-gradient-to-b dark:from-[#0F0F0F] dark:to-[#1A1A1A] flex items-center justify-center p-6 text-slate-900 dark:text-slate-100">
    <!-- Theme Toggle Button -->
    <button class="theme-toggle" id="theme-toggle" aria-label="Toggle dark mode">
      <span id="theme-icon">ðŸŒ™</span>
    </button>

    <div class="reveal-page-wrapper flex flex-col items-center justify-center min-h-screen">
      <!-- Logo -->
      <div class="logo text-6xl mb-8" style="color: var(--text-dark);">Arcana</div>

      <!-- Title -->
      <div class="text-center mb-16 max-w-lg">
        <h1 class="serif-title text-5xl md:text-6xl font-normal text-dark leading-tight">Scan Your Memory</h1>
      </div>

      <!-- NFC & Manual Entry -->
      <div class="w-full max-w-md mb-12">
        <div id="nfc-area" class="space-y-6">
          <!-- Scan Button -->
          <button id="btn-scan" class="btn-primary w-full flex items-center justify-center gap-3">
            <i data-lucide="radio" class="w-5 h-5"></i>
            <span>Scan</span>
          </button>

          <!-- Divider -->
          <div class="flex items-center gap-4 my-8">
            <div class="flex-1 h-px bg-gold/15"></div>
            <span class="text-sm text-medium opacity-50">or</span>
            <div class="flex-1 h-px bg-gold/15"></div>
          </div>

          <!-- Manual ID Input -->
          <div>
            <input id="manual-id" type="text" placeholder="Enter item ID" class="w-full p-4 rounded-lg border border-gold/20 focus:border-gold/40 focus:outline-none transition text-center" style="background-color: var(--bg-white); color: var(--text-dark);" />
          </div>

          <!-- Submit Button -->
          <button id="btn-go" class="btn-primary-outline w-full flex items-center justify-center gap-3">
            <span>Open</span>
            <i data-lucide="arrow-right" class="w-5 h-5"></i>
          </button>
        </div>
      </div>

    </div>

    <script>
      // Attempt Web NFC read and redirect; fallback to manual input
      const btnScan = document.getElementById('btn-scan');
      const btnGo = document.getElementById('btn-go');
      const manual = document.getElementById('manual-id');

      async function redirectToItem(id) {
        if (!id) return alert('Please provide an item ID.');
        // Normalize id
        const safe = encodeURIComponent(String(id).trim());
        window.location.href = `device.html?item=${safe}`;
      }

      btnGo.addEventListener('click', () => redirectToItem(manual.value));

      btnScan.addEventListener('click', async () => {
        if (!('NDEFReader' in window)) {
          alert('Web NFC is not supported on this device/browser. Please enter the ID manually.');
          return;
        }

        try {
          const ndef = new NDEFReader();
          await ndef.scan();
          btnScan.innerHTML = '<i data-lucide="loader-circle" class="w-5 h-5 animate-spin"></i><span>Scanningâ€¦</span>';
          btnScan.disabled = true;
          ndef.onreading = event => {
            try {
              const decoder = new TextDecoder();
              const record = event.message.records[0];
              let payload = '';
              if (record && record.data) payload = decoder.decode(record.data);
              // Some tags provide text in record.payload instead; try both
              if (!payload && record && record.recordType === 'text') payload = decoder.decode(record.data);
              const id = payload || event.serialNumber || prompt('Tag read, but no ID found. Enter ID manually:');
              redirectToItem(id);
            } catch (e) {
              alert('Failed to read tag payload. Enter ID manually.');
              btnScan.innerHTML = '<i data-lucide="radio" class="w-5 h-5"></i><span>Scan</span>';
              btnScan.disabled = false;
            }
          };
        } catch (err) {
          alert('Failed to start NFC scan: ' + err.message);
          btnScan.innerHTML = '<i data-lucide="radio" class="w-5 h-5"></i><span>Scan</span>';
          btnScan.disabled = false;
        }
      });

      // Initialize Lucide icons
      lucide.createIcons();
    </script>
  </body>
</html>